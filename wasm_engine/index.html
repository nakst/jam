<!DOCTYPE html>
<html>
	<head>
		<title>Game</title>

		<meta charset="utf-8">

		<style>
			* {
				margin: 0;
				padding: 0;
			}

			html {
				height: 100%;
			}

			body {
				height: 100%;
				background-color: black;
				display: flex;
				justify-content: center;
			}

			#canvas {
				position: absolute;
				height: 100%;
				image-rendering: crisp-edges;
				image-rendering: pixelated;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas">
		</canvas>

		<script>
			gameWidth = 320;
			gameHeight = 200;
			panic = false;
			initialised = false;
			sounds = {};
			canvas = document.getElementById("canvas");
			context = canvas.getContext("2d");
			canvas.width = gameWidth;
			canvas.height = gameHeight;
			context.fillStyle = "black";
			context.fillRect(0, 0, gameWidth, gameHeight);
			context.fillStyle = "white";
			context.font = "24px sans-serif";
			context.fillText("Click here to start!", 0, gameHeight / 2);

			function UpdateFrame() {
				if (panic) return;
				instance.exports.GenerateFrame(Date.now());
				context.putImageData(imageData, 0, 0);
				window.requestAnimationFrame(UpdateFrame);
			}

			function PlaySound(name, nameBytes, loop) {
				name = new TextDecoder().decode(new Uint8Array(memory.buffer, name, nameBytes));
				if (!(name in sounds)) sounds[name] = new Audio(name);
				sounds[name].loop = !!loop;
				sounds[name].play();
			}

			async function Initialise() {
				memory = new WebAssembly.Memory({ initial: 256 /* 16 MB; keep in sync with build.bat */ });
				rom = await (await fetch("game.wasm")).arrayBuffer();
				environment = { memory: memory };
				environment.LogInteger = (x) => { console.log(x); }; 
				environment.Panic = () => { panic = true; console.log("Panic!"); }; 
				environment.PlaySound = PlaySound;
				instance = (await WebAssembly.instantiate(rom, { env: environment })).instance;
				imageArray = new Uint8ClampedArray(memory.buffer, instance.exports.__heap_base.value, gameWidth * gameHeight * 4);
				imageData = new ImageData(imageArray, gameWidth, gameHeight);
				instance.exports.Initialise();
				window.requestAnimationFrame(UpdateFrame);

				window.addEventListener("keydown", (e) => {
					if (e.repeat || e.keyCode > 255) return;
					instance.exports.HandleEvent(1, e.keyCode);
				});

				window.addEventListener("keyup", (e) => {
					if (e.keyCode > 255) return;
					instance.exports.HandleEvent(2, e.keyCode);
				});
			}

			window.addEventListener("mousedown", (e) => { 
				// Require a click to prevent audio blocking.
				if (!initialised) Initialise(); 
				initialised = true; 
			});
		</script>
	</body>
</html>
